/*********************************************************************************************************
**
**                                北京翼辉信息技术有限公司
**
**                                  微型安全实时操作系统
**
**                                      MS-RTOS(TM)
**
**                               Copyright All Rights Reserved
**
**--------------文件信息--------------------------------------------------------------------------------
**
** 文   件   名: iot_pi_pro_ts.c
**
** 创   建   人: Yu.kangzhi
**
** 文件创建日期: 2020 年 04 月 07 日
**
** 描        述: IoT Pi Pro Touch Screen 驱动
**
** 参 考 文  件: stm32h750b_discovery_ts.c
*********************************************************************************************************/

#include "ms_config.h"
#include "ms_rtos.h"
#include "includes.h"
#include "iot_pi_pro.h"

#include "touch/ms_drv_gt9xx.h"

/*********************************************************************************************************
 TouchScreen Slave I2C address: GT911 的I2C 从设备地址有两组，分别为0xBA/0xBB 和0x28/0x29。
 主控在上电初始化时控制 Reset 和 INT 口状态进行设定。此地址为7位地址左移一位后的地址(实际测试时发现)
*********************************************************************************************************/

#define TS_I2C_ADDRESS                     (0xBA >> 1)

/*********************************************************************************************************
 Touch screen interrupt signal
*********************************************************************************************************/

#define TS_INT_PIN                         GPIO_PIN_8
#define TS_INT_GPIO_PORT                   GPIOC
#define TS_INT_GPIO_CLK_ENABLE()           __HAL_RCC_GPIOC_CLK_ENABLE()
#define TS_INT_GPIO_CLK_DISABLE()          __HAL_RCC_GPIOC_CLK_DISABLE()
#define TS_INT_EXTI_IRQn                   EXTI9_5_IRQn
#define TS_EXTI_LINE                       EXTI_LINE_8

#define TS_RST_PIN                         GPIO_PIN_7
#define TS_RST_GPIO_PORT                   GPIOD
#define TS_RST_GPIO_CLK_ENABLE()           __HAL_RCC_GPIOD_CLK_ENABLE()
#define TS_RST_GPIO_CLK_DISABLE()          __HAL_RCC_GPIOD_CLK_DISABLE()

/*
 * PanelSize: 5 inch
 * TP DRV IC: GT9157
 */
ms_uint8_t CTP_CFG_GT9157[] ={
    0x00,0x20,0x03,0xE0,0x01,0x05,0x3C,0x00,0x01,0x08,
    0x28,0x0C,0x50,0x32,0x03,0x05,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x17,0x19,0x1E,0x14,0x8B,0x2B,0x0D,
    0x33,0x35,0x0C,0x08,0x00,0x00,0x00,0x9A,0x03,0x11,
    0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x32,0x00,0x00,
    0x00,0x20,0x58,0x94,0xC5,0x02,0x00,0x00,0x00,0x04,
    0xB0,0x23,0x00,0x93,0x2B,0x00,0x7B,0x35,0x00,0x69,
    0x41,0x00,0x5B,0x4F,0x00,0x5B,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x02,0x04,0x06,0x08,0x0A,0x0C,0x0E,0x10,
    0x12,0x14,0x16,0x18,0x1A,0xFF,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x02,0x04,0x06,0x08,0x0A,0x0C,0x0F,
    0x10,0x12,0x13,0x16,0x18,0x1C,0x1D,0x1E,0x1F,0x20,
    0x21,0x22,0x24,0x26,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
    0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFF,0x48,0x01
};

/*
 * PanelSize: 4.3 inch
 * TP DRV IC: GT911
 */
ms_uint8_t CTP_CFG_GT911[] =  {
    0x00,0xE0,0x01,0x10,0x01,0x05,0x0D,0x00,0x01,0x08,
    0x19,0x0F,0x5A,0x3C,0x03,0x05,0x00,0x00,0x00,0x00,
    0x00,0x00,0x06,0x17,0x19,0x1E,0x14,0x8C,0x23,0x0A,
    0x7F,0x81,0x7C,0x06,0x00,0x00,0x00,0x98,0x02,0x1C,
    0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,
    0x00,0x5A,0x96,0x94,0xC5,0x03,0x00,0x00,0x00,0x04,
    0x8B,0x60,0x00,0x85,0x6F,0x00,0x80,0x7F,0x00,0x7C,
    0x92,0x00,0x79,0xA8,0x00,0x79,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x04,0x06,0x08,0x0A,0x0C,0x0E,0x10,0x12,
    0x14,0x16,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0x00,0x00,0x00,
    0x00,0x00,0x00,0x02,0x04,0x06,0x08,0x0A,0x0C,0x0F,
    0x10,0x12,0x13,0x14,0x16,0x18,0x1C,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x24,0x01
};

/*
 * PanelSize: 4.3 inch
 * TP DRV IC: GT615
 */
ms_uint8_t CTP_CFG_GT615[]=
{
    0x56,0xE0,0x01,0x10,0x01,0x01,0x0D,0x00,0x02,0x2A,
    0x19,0x0F,0x5A,0x3C,0x03,0x05,0x00,0x00,0x00,0x00,
    0x00,0x00,0x06,0x17,0x19,0x1E,0x14,0x8C,0x23,0x0A,
    0x7F,0x81,0x7C,0x06,0x00,0x00,0x00,0x98,0x02,0x1C,
    0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,
    0x00,0x5A,0x96,0x94,0xC5,0x03,0x00,0x00,0x00,0x04,
    0x8B,0x60,0x00,0x85,0x6F,0x00,0x80,0x7F,0x00,0x7C,
    0x92,0x00,0x79,0xA8,0x00,0x79,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x04,0x06,0x08,0x0A,0x0C,0x0E,0x10,0x12,
    0x14,0x16,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0x00,0x00,0x00,
    0x00,0x00,0x00,0x02,0x04,0x06,0x08,0x0A,0x0C,0x0F,
    0x10,0x12,0x13,0x14,0x16,0x18,0x1C,0xFF,0xFF,0xFF,
    0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0xB2,0x01
};

/*
 * GT911 reset timing of selecting i2c address
 */
static void gt9xx_init_i2c_addr(ms_uint16_t *address)
{
    GPIO_InitTypeDef gpio_init_structure;

    TS_RST_GPIO_CLK_ENABLE();
    TS_INT_GPIO_CLK_ENABLE();

    /* PD7-TP_RST */
    gpio_init_structure.Pin   = TS_RST_PIN;
    gpio_init_structure.Mode  = GPIO_MODE_OUTPUT_PP;
    gpio_init_structure.Pull  = GPIO_PULLUP;
    gpio_init_structure.Speed = GPIO_SPEED_FREQ_VERY_HIGH;
    HAL_GPIO_Init(TS_RST_GPIO_PORT, &gpio_init_structure);
    HAL_GPIO_WritePin(TS_RST_GPIO_PORT, TS_RST_PIN, GPIO_PIN_SET);
    HAL_GPIO_WritePin(TS_RST_GPIO_PORT, TS_RST_PIN, GPIO_PIN_RESET);

    /* PC8-TP_nINT */
    gpio_init_structure.Pin   = TS_INT_PIN;
    gpio_init_structure.Mode  = GPIO_MODE_OUTPUT_PP;
    gpio_init_structure.Pull  = GPIO_PULLUP;
    gpio_init_structure.Speed = GPIO_SPEED_FREQ_VERY_HIGH;
    HAL_GPIO_Init(TS_INT_GPIO_PORT, &gpio_init_structure);
    HAL_GPIO_WritePin(TS_INT_GPIO_PORT, TS_INT_PIN, GPIO_PIN_RESET);

    /* I2C Addr select: 0xBA */
    bsp_delay_us(200);
    HAL_GPIO_WritePin(TS_RST_GPIO_PORT, TS_RST_PIN, GPIO_PIN_SET);
    ms_thread_sleep_ms(10);
    HAL_GPIO_WritePin(TS_INT_GPIO_PORT, TS_INT_PIN, GPIO_PIN_RESET);
    ms_thread_sleep_ms(60);

    /* PC8-TP_nINT (input mode) */
    gpio_init_structure.Pin   = TS_INT_PIN;
    gpio_init_structure.Mode  = GPIO_MODE_INPUT;
    gpio_init_structure.Pull  = GPIO_NOPULL;
    gpio_init_structure.Speed = GPIO_SPEED_FREQ_VERY_HIGH;
    HAL_GPIO_Init(TS_INT_GPIO_PORT, &gpio_init_structure);

    *address = TS_I2C_ADDRESS;
}

/*
 * Touch panel info
 */
static ms_gtxxx_port_t  gt911_480272_port = {
    .type          = MS_GTXXX_TYPE_GT911,
    .product_id[0] = '9',
    .product_id[1] = '1',
    .product_id[2] = '1',
    .cfg_tbl_buf   = CTP_CFG_GT911,
    .cfg_tbl_len   = sizeof(CTP_CFG_GT911),
    .inch_size     = 4.3,
    .abs_x_max     = 480,
    .abs_y_max     = 272,
};

/*
 * Register gt9xx device driver
 */
ms_err_t gt911_drv_register(void)
{
    return ms_gt9xx_drv_register();
}

/*
 * Create gt9xx device file
 */
ms_err_t gt911_dev_create(const char *path, const char *i2c_bus_name)
{
    ms_uint16_t dev_addr;

    gt9xx_init_i2c_addr(&dev_addr);

    return ms_gt9xx_dev_create(path, i2c_bus_name, dev_addr, &gt911_480272_port);
}
/*********************************************************************************************************
 END
*********************************************************************************************************/
